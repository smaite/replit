<?php
/**
 * Product Upload & Verification System
 * Products require admin approval before being visible to customers
 */

// products.php for vendors - updated to include verification status

// Check vendor access
$vendor_check = "
<?php
require_once '../config/config.php';
require_once '../config/database.php';

if (!isLoggedIn() || !isVendor()) {
    redirect('/auth/login.php');
}

// Get vendor
\$stmt = \$conn->prepare('SELECT * FROM vendors WHERE user_id = ?');
\$stmt->execute([\$_SESSION['user_id']]);
\$vendor = \$stmt->fetch();

if (!vendor) {
    redirect('/auth/become-vendor.php');
}

\$error = '';
\$success = '';

// Handle product upload
if (\$_SERVER['REQUEST_METHOD'] === 'POST' && isset(\$_POST['action'])) {
    if (!\$_POST['csrf_token'] || !\$_POST['csrf_token'] === generateCsrfToken()) {
        \$error = 'Security token invalid';
    } else {
        if (\$_POST['action'] === 'upload') {
            // Handle product upload
            \$name = sanitize(\$_POST['product_name'] ?? '');
            \$description = sanitize(\$_POST['description'] ?? '');
            \$price = (float)(\$_POST['price'] ?? 0);
            \$category_id = (int)(\$_POST['category_id'] ?? 0);
            
            if (empty(\$name) || empty(\$description) || \$price <= 0 || \$category_id <= 0) {
                \$error = 'Please fill in all required fields';
            } elseif (empty(\$_FILES['product_image']['name'])) {
                \$error = 'Please upload a product image';
            } else {
                // Validate image
                \$file = \$_FILES['product_image'];
                \$allowed_types = ['image/jpeg', 'image/png', 'image/webp'];
                \$max_size = 5 * 1024 * 1024; // 5MB
                
                if (!\$in_array(\$file['type'], \$allowed_types)) {
                    \$error = 'Only JPEG, PNG, and WebP images are allowed';
                } elseif (\$file['size'] > \$max_size) {
                    \$error = 'Image size must not exceed 5MB';
                } else {
                    // Create upload directory
                    \$upload_dir = '../uploads/products/';
                    if (!is_dir(\$upload_dir)) {
                        mkdir(\$upload_dir, 0755, true);
                    }
                    
                    // Save image
                    \$filename = time() . '_' . \$vendor['id'] . '_' . basename(\$file['name']);
                    \$filepath = \$upload_dir . \$filename;
                    \$image_url = '/uploads/products/' . \$filename;
                    
                    if (move_uploaded_file(\$file['tmp_name'], \$filepath)) {
                        // Insert product with pending status
                        \$stmt = \$conn->prepare('INSERT INTO products 
                            (vendor_id, category_id, name, description, price, image_url, verification_status, created_at) 
                            VALUES (?, ?, ?, ?, ?, ?, \"pending\", NOW())');
                        
                        if (\$stmt->execute([\$vendor['id'], \$category_id, \$name, \$description, \$price, \$image_url])) {
                            \$success = 'Product uploaded successfully! It will be visible after admin approval.';
                        } else {
                            \$error = 'Failed to save product. Please try again.';
                            unlink(\$filepath);
                        }
                    } else {
                        \$error = 'Failed to upload image';
                    }
                }
            }
        }
    }
}
";

// Schema addition needed in database
$schema_needed = "
ALTER TABLE products ADD COLUMN IF NOT EXISTS verification_status ENUM('pending', 'approved', 'rejected') DEFAULT 'pending' AFTER visible;
ALTER TABLE products ADD COLUMN IF NOT EXISTS rejection_reason VARCHAR(500) NULL AFTER verification_status;
ALTER TABLE products ADD COLUMN IF NOT EXISTS verified_by INT NULL AFTER rejection_reason;
ALTER TABLE products ADD COLUMN IF NOT EXISTS verified_at TIMESTAMP NULL AFTER verified_by;
";
?>
